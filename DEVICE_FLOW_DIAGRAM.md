# Device Provisioning Flow - Visual Diagram

## Complete Lifecycle: From Unboxing to Data Collection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DEVICE LIFECYCLE FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PHASE 1: DEVICE COMES ONLINE (Real World)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  ğŸ“¦ Device Unboxed in Field
        â†“
  ğŸ”Œ Powered On
        â†“
  ğŸ“¡ Connects to WiFi
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Device: CF:B1:55:36:BC:95         â”‚
  â”‚  Status: First Boot                 â”‚
  â”‚  Location: Unknown                  â”‚
  â”‚  Assignment: None                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
        â†“ Publishes MQTT Message
        â†“ Topic: device/CF:B1:55:36:BC:95/status
        â†“ Payload: {"device_id": "CF:B1:55:36:BC:95", "status": "alive"}
        â†“


PHASE 2: MQTT EDGE FUNCTION (Auto-Provisioning)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Supabase Edge Function           â”‚
  â”‚   mqtt_device_handler               â”‚
  â”‚                                     â”‚
  â”‚   ğŸ“¨ Receives status message       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
        â†“ Queries database
        â†“ SELECT * FROM devices WHERE device_mac = 'CF:B1:55:36:BC:95'
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   âŒ Device Not Found               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
        â†“ Auto-Provision Triggered!
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   ğŸ¤– autoProvisionDevice()         â”‚
  â”‚                                     â”‚
  â”‚   1. Generate device code          â”‚
  â”‚      "DEVICE-ESP32S3-001"          â”‚
  â”‚                                     â”‚
  â”‚   2. Insert into devices table     â”‚
  â”‚      - device_mac: CF:B1:...       â”‚
  â”‚      - device_code: DEVICE-ESP...  â”‚
  â”‚      - provisioning_status:        â”‚
  â”‚        "pending_mapping"            â”‚
  â”‚      - site_id: NULL               â”‚
  â”‚      - program_id: NULL            â”‚
  â”‚      - is_active: false             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
        â†“
  âœ… Device Auto-Provisioned!
        â†“


PHASE 3: DATABASE STATE (After Auto-Provision)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  devices table                                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  device_id: uuid-1234                           â”‚
  â”‚  device_mac: CF:B1:55:36:BC:95                  â”‚
  â”‚  device_code: DEVICE-ESP32S3-001      â† NEW!    â”‚
  â”‚  device_name: null                              â”‚
  â”‚  site_id: null                        â† NULL    â”‚
  â”‚  program_id: null                     â† NULL    â”‚
  â”‚  provisioning_status: pending_mapping â† KEY!    â”‚
  â”‚  is_active: false                               â”‚
  â”‚  last_seen_at: 2025-11-08T...                   â”‚
  â”‚  notes: "Auto-provisioned via MQTT"             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PHASE 4: ADMIN UI (Pending Devices)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  Browser â†’ /devices
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸ“± Devices Page                                             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                               â”‚
  â”‚  âš ï¸  1 Device Awaiting Mapping                               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  DEVICE-ESP32S3-001                           â”‚  â”‚
  â”‚  â”‚  â”‚ğŸ“·  â”‚  MAC: CF:B1:55:36:BC:95                        â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”˜  Status: pending_mapping                       â”‚  â”‚
  â”‚  â”‚          Last Seen: 2 minutes ago                      â”‚  â”‚
  â”‚  â”‚                                                         â”‚  â”‚
  â”‚  â”‚          Reported Site: unknown                        â”‚  â”‚
  â”‚  â”‚          Location: unknown                             â”‚  â”‚
  â”‚  â”‚                                                         â”‚  â”‚
  â”‚  â”‚          [Setup Device]  [View Details]                â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                               â”‚
  â”‚  ğŸ“Š Active Devices (0)                                       â”‚
  â”‚  No active devices yet...                                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PHASE 5: DEVICE ASSIGNMENT (Admin Action)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  Admin clicks [Setup Device]
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸ§™â€â™‚ï¸ Device Setup Wizard                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                   â”‚
  â”‚  Step 1: Select Program                          â”‚
  â”‚  â—‹ â†’ â—‹ â†’ â—‹ â†’ â—‹ â†’ â—‹                               â”‚
  â”‚                                                   â”‚
  â”‚  â–¼ Choose Pilot Program:                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
  â”‚  â”‚ Greenhouse Trial 2025          â–¼ â”‚            â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
  â”‚                                                   â”‚
  â”‚              [Cancel]  [Next â†’]                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 2: Select Site                             â”‚
  â”‚  â—‹ â†’ â— â†’ â—‹ â†’ â—‹ â†’ â—‹                               â”‚
  â”‚                                                   â”‚
  â”‚  â–¼ Choose Site:                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
  â”‚  â”‚ Site A - Greenhouse North      â–¼ â”‚            â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
  â”‚                                                   â”‚
  â”‚              [â† Back]  [Next â†’]                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 3: Device Identity                         â”‚
  â”‚  â—‹ â†’ â—‹ â†’ â— â†’ â—‹ â†’ â—‹                               â”‚
  â”‚                                                   â”‚
  â”‚  Device Name:                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
  â”‚  â”‚ North Greenhouse - Camera 1      â”‚            â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
  â”‚                                                   â”‚
  â”‚  Device Code: DEVICE-ESP32S3-001                 â”‚
  â”‚  MAC Address: CF:B1:55:36:BC:95                  â”‚
  â”‚                                                   â”‚
  â”‚              [â† Back]  [Next â†’]                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 4: Wake Schedule                           â”‚
  â”‚  â—‹ â†’ â—‹ â†’ â—‹ â†’ â— â†’ â—‹                               â”‚
  â”‚                                                   â”‚
  â”‚  â—‰ Twice Daily (8am & 4pm)                       â”‚
  â”‚  â—‹ Three Times Daily                             â”‚
  â”‚  â—‹ Once Daily                                    â”‚
  â”‚  â—‹ Custom Schedule                               â”‚
  â”‚                                                   â”‚
  â”‚              [â† Back]  [Next â†’]                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 5: Review & Complete                       â”‚
  â”‚  â—‹ â†’ â—‹ â†’ â—‹ â†’ â—‹ â†’ â—                               â”‚
  â”‚                                                   â”‚
  â”‚  âœ“ Program: Greenhouse Trial 2025                â”‚
  â”‚  âœ“ Site: Site A - Greenhouse North               â”‚
  â”‚  âœ“ Name: North Greenhouse - Camera 1             â”‚
  â”‚  âœ“ Schedule: Twice Daily (8am & 4pm)             â”‚
  â”‚  âœ“ Code: DEVICE-ESP32S3-001                      â”‚
  â”‚                                                   â”‚
  â”‚              [â† Back]  [Complete Setup âœ“]        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
        â†“ Submits Assignment
        â†“


PHASE 6: DATABASE UPDATES (Assignment Created)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  Parallel Updates:
        â†“
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â†“                 â†“                 â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  devices     â”‚  â”‚ device_site_    â”‚  â”‚ device_program_  â”‚
  â”‚  table       â”‚  â”‚ assignments     â”‚  â”‚ assignments      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ UPDATE:      â”‚  â”‚ INSERT:         â”‚  â”‚ INSERT:          â”‚
  â”‚              â”‚  â”‚                 â”‚  â”‚                  â”‚
  â”‚ site_id:     â”‚  â”‚ device_id: ...  â”‚  â”‚ device_id: ...   â”‚
  â”‚   uuid-site  â”‚  â”‚ site_id: ...    â”‚  â”‚ program_id: ...  â”‚
  â”‚              â”‚  â”‚ program_id: ... â”‚  â”‚ is_primary: true â”‚
  â”‚ program_id:  â”‚  â”‚ is_primary: trueâ”‚  â”‚ is_active: true  â”‚
  â”‚   uuid-prog  â”‚  â”‚ is_active: true â”‚  â”‚ assigned_at: now â”‚
  â”‚              â”‚  â”‚ assigned_at: nowâ”‚  â”‚ assigned_by: ... â”‚
  â”‚ device_name: â”‚  â”‚ assigned_by: ...â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚   "North..." â”‚  â”‚ reason: "..."   â”‚
  â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ provisioning â”‚
  â”‚ _status:     â”‚
  â”‚   "active"   â”‚
  â”‚              â”‚
  â”‚ is_active:   â”‚
  â”‚   true       â”‚
  â”‚              â”‚
  â”‚ mapped_at:   â”‚
  â”‚   now        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PHASE 7: DEVICE NOW OPERATIONAL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ğŸ“· Device: North Greenhouse - Camera 1        â”‚
  â”‚  ğŸ·ï¸  Code: DEVICE-ESP32S3-001                  â”‚
  â”‚  ğŸ“ Site: Site A - Greenhouse North            â”‚
  â”‚  ğŸ“Š Program: Greenhouse Trial 2025             â”‚
  â”‚  âœ… Status: active                              â”‚
  â”‚  ğŸŸ¢ Online (Last seen: 30 seconds ago)         â”‚
  â”‚  ğŸ”‹ Battery: 95%                                â”‚
  â”‚  ğŸ“¸ Images: 0                                   â”‚
  â”‚  â° Next Wake: Today at 4:00 PM                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PHASE 8: IMAGE CAPTURE CYCLE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  Device wakes up at 8:00 AM
        â†“
  Captures image of petri dish
        â†“
  Sends image chunks via MQTT
        â†“
  Edge function receives & reassembles
        â†“
  Uploads to Supabase Storage
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Creates Submission:                     â”‚
  â”‚  - site_id: Site A                       â”‚
  â”‚  - program_id: Greenhouse Trial          â”‚
  â”‚  - created_by_device_id: uuid            â”‚
  â”‚  - is_device_generated: true             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Creates Petri Observation:              â”‚
  â”‚  - submission_id: ...                    â”‚
  â”‚  - image_url: https://...                â”‚
  â”‚  - is_device_generated: true             â”‚
  â”‚  - device_capture_metadata: {...}        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  âœ… Data captured and stored!
        â†“
  Device goes back to sleep
        â†“
  Next wake: 4:00 PM


CONTINUOUS CYCLE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  8:00 AM â†’ Capture â†’ Upload â†’ Sleep
                â†“
  4:00 PM â†’ Capture â†’ Upload â†’ Sleep
                â†“
  8:00 AM â†’ Capture â†’ Upload â†’ Sleep
                â†“
              (Repeat daily)


KEY OBSERVATIONS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ“ Device self-registers on first connection
âœ“ No pre-configuration required in field
âœ“ Device appears immediately in pending list
âœ“ Admin can assign when site info is known
âœ“ Complete assignment history tracked
âœ“ Junction tables enable future many-to-many
âœ“ Device can be reassigned without data loss
âœ“ All historical assignments preserved
âœ“ Ready for deep analytics
```

## Summary

This flow demonstrates:

1. **Zero-Touch Provisioning**: Device connects â†’ Automatically registers
2. **Flexible Assignment**: Assign immediately or later
3. **Complete History**: Every assignment change tracked
4. **Many-to-Many Ready**: Architecture supports complex assignments
5. **Field-Friendly**: No manual MAC address entry needed
6. **Audit Trail**: Who assigned what, when, and why
7. **Data Integrity**: Historical context never lost
8. **Responsive UI**: Works on mobile devices in the field

The device goes from unboxing to operational in minutes, with complete flexibility in the assignment workflow.
